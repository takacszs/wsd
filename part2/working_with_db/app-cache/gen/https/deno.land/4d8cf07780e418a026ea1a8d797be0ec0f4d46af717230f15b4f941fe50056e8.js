// Copyright 2018-2022 the oak authors. All rights reserved. MIT license.
import { isRouterContext } from "../util.ts";
const FORWARDED_RE = /^(,[ \\t]*)*([!#$%&'*+.^_`|~0-9A-Za-z-]+=([!#$%&'*+.^_`|~0-9A-Za-z-]+|\"([\\t \\x21\\x23-\\x5B\\x5D-\\x7E\\x80-\\xFF]|\\\\[\\t \\x21-\\x7E\\x80-\\xFF])*\"))?(;([!#$%&'*+.^_`|~0-9A-Za-z-]+=([!#$%&'*+.^_`|~0-9A-Za-z-]+|\"([\\t \\x21\\x23-\\x5B\\x5D-\\x7E\\x80-\\xFF]|\\\\[\\t \\x21-\\x7E\\x80-\\xFF])*\"))?)*([ \\t]*,([ \\t]*([!#$%&'*+.^_`|~0-9A-Za-z-]+=([!#$%&'*+.^_`|~0-9A-Za-z-]+|\"([\\t \\x21\\x23-\\x5B\\x5D-\\x7E\\x80-\\xFF]|\\\\[\\t \\x21-\\x7E\\x80-\\xFF])*\"))?(;([!#$%&'*+.^_`|~0-9A-Za-z-]+=([!#$%&'*+.^_`|~0-9A-Za-z-]+|\"([\\t \\x21\\x23-\\x5B\\x5D-\\x7E\\x80-\\xFF]|\\\\[\\t \\x21-\\x7E\\x80-\\xFF])*\"))?)*)?)*$/;
function createMatcher({ match  }) {
    return function matches(ctx) {
        if (!match) {
            return true;
        }
        if (typeof match === "string") {
            return ctx.request.url.pathname.startsWith(match);
        }
        if (match instanceof RegExp) {
            return match.test(ctx.request.url.pathname);
        }
        return match(ctx);
    };
}
async function createRequest(target, ctx, { headers: optHeaders , map , proxyHeaders =true , request: reqFn  }) {
    let path = ctx.request.url.pathname;
    let params;
    if (isRouterContext(ctx)) {
        params = ctx.params;
    }
    if (map && typeof map === "function") {
        path = map(path, params);
    } else if (map) {
        path = map[path] ?? path;
    }
    const url = new URL(String(target));
    if (url.pathname.endsWith("/") && path.startsWith("/")) {
        url.pathname = `${url.pathname}${path.slice(1)}`;
    } else if (!url.pathname.endsWith("/") && !path.startsWith("/")) {
        url.pathname = `${url.pathname}/${path}`;
    } else {
        url.pathname = `${url.pathname}${path}`;
    }
    url.search = ctx.request.url.search;
    const body = getBodyInit(ctx);
    const headers = new Headers(ctx.request.headers);
    if (optHeaders) {
        if (typeof optHeaders === "function") {
            optHeaders = await optHeaders(ctx);
        }
        for (const [key, value] of iterableHeaders(optHeaders)){
            headers.set(key, value);
        }
    }
    if (proxyHeaders) {
        const maybeForwarded = headers.get("forwarded");
        const ip = ctx.request.ip.startsWith("[") ? `"${ctx.request.ip}"` : ctx.request.ip;
        const host = headers.get("host");
        if (maybeForwarded && FORWARDED_RE.test(maybeForwarded)) {
            let value1 = `for=${ip}`;
            if (host) {
                value1 += `;host=${host}`;
            }
            headers.append("forwarded", value1);
        } else {
            headers.append("x-forwarded-for", ip);
            if (host) {
                headers.append("x-forwarded-host", host);
            }
        }
    }
    const init = {
        body,
        headers,
        method: ctx.request.method,
        redirect: "follow"
    };
    let request = new Request(url.toString(), init);
    if (reqFn) {
        request = await reqFn(request);
    }
    return request;
}
function getBodyInit(ctx) {
    if (!ctx.request.hasBody) {
        return null;
    }
    return ctx.request.body({
        type: "stream"
    }).value;
}
function iterableHeaders(headers) {
    if (headers instanceof Headers) {
        return headers.entries();
    } else if (Array.isArray(headers)) {
        return headers.values();
    } else {
        return Object.entries(headers).values();
    }
}
async function processResponse(response, ctx, { contentType: contentTypeFn , response: resFn  }) {
    if (resFn) {
        response = await resFn(response);
    }
    if (response.body) {
        ctx.response.body = response.body;
    } else {
        ctx.response.body = null;
    }
    ctx.response.status = response.status;
    for (const [key, value] of response.headers){
        ctx.response.headers.append(key, value);
    }
    if (contentTypeFn) {
        const value1 = await contentTypeFn(response.url, ctx.response.headers.get("content-type") ?? undefined);
        if (value1 != null) {
            ctx.response.headers.set("content-type", value1);
        }
    }
}
export function proxy(target, options = {}) {
    const matches = createMatcher(options);
    return async function proxy(ctx, next) {
        if (!matches(ctx)) {
            return next();
        }
        const request = await createRequest(target, ctx, options);
        const { fetch =globalThis.fetch  } = options;
        const response = await fetch(request);
        await processResponse(response, ctx, options);
        return next();
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImh0dHBzOi8vZGVuby5sYW5kL3gvb2FrQHYxMS4xLjAvbWlkZGxld2FyZS9wcm94eS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOC0yMDIyIHRoZSBvYWsgYXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4gTUlUIGxpY2Vuc2UuXG5cbmltcG9ydCB0eXBlIHsgU3RhdGUgfSBmcm9tIFwiLi4vYXBwbGljYXRpb24udHNcIjtcbmltcG9ydCB0eXBlIHsgQ29udGV4dCB9IGZyb20gXCIuLi9jb250ZXh0LnRzXCI7XG5pbXBvcnQgdHlwZSB7IE1pZGRsZXdhcmUgfSBmcm9tIFwiLi4vbWlkZGxld2FyZS50c1wiO1xuaW1wb3J0IHR5cGUge1xuICBSb3V0ZVBhcmFtcyxcbiAgUm91dGVyQ29udGV4dCxcbiAgUm91dGVyTWlkZGxld2FyZSxcbn0gZnJvbSBcIi4uL3JvdXRlci50c1wiO1xuaW1wb3J0IHsgaXNSb3V0ZXJDb250ZXh0IH0gZnJvbSBcIi4uL3V0aWwudHNcIjtcblxuZXhwb3J0IHR5cGUgRmV0Y2ggPSAoaW5wdXQ6IFJlcXVlc3QpID0+IFByb21pc2U8UmVzcG9uc2U+O1xuXG5leHBvcnQgdHlwZSBQcm94eU1hdGNoRnVuY3Rpb248XG4gIFIgZXh0ZW5kcyBzdHJpbmcsXG4gIFAgZXh0ZW5kcyBSb3V0ZVBhcmFtczxSPiA9IFJvdXRlUGFyYW1zPFI+LFxuICAvLyBkZW5vLWxpbnQtaWdub3JlIG5vLWV4cGxpY2l0LWFueVxuICBTIGV4dGVuZHMgU3RhdGUgPSBSZWNvcmQ8c3RyaW5nLCBhbnk+LFxuPiA9IChjdHg6IENvbnRleHQ8Uz4gfCBSb3V0ZXJDb250ZXh0PFIsIFAsIFM+KSA9PiBib29sZWFuO1xuXG5leHBvcnQgdHlwZSBQcm94eU1hcEZ1bmN0aW9uPFIgZXh0ZW5kcyBzdHJpbmcsIFAgZXh0ZW5kcyBSb3V0ZVBhcmFtczxSPj4gPSAoXG4gIHBhdGg6IFIsXG4gIHBhcmFtcz86IFAsXG4pID0+IFI7XG5cbmV4cG9ydCB0eXBlIFByb3h5SGVhZGVyc0Z1bmN0aW9uPFMgZXh0ZW5kcyBTdGF0ZT4gPSAoXG4gIGN0eDogQ29udGV4dDxTPixcbikgPT4gSGVhZGVyc0luaXQgfCBQcm9taXNlPEhlYWRlcnNJbml0PjtcblxuZXhwb3J0IHR5cGUgUHJveHlSb3V0ZXJIZWFkZXJzRnVuY3Rpb248XG4gIFIgZXh0ZW5kcyBzdHJpbmcsXG4gIFAgZXh0ZW5kcyBSb3V0ZVBhcmFtczxSPixcbiAgUyBleHRlbmRzIFN0YXRlLFxuPiA9IChjdHg6IFJvdXRlckNvbnRleHQ8UiwgUCwgUz4pID0+IEhlYWRlcnNJbml0IHwgUHJvbWlzZTxIZWFkZXJzSW5pdD47XG5cbmV4cG9ydCBpbnRlcmZhY2UgUHJveHlPcHRpb25zPFxuICBSIGV4dGVuZHMgc3RyaW5nLFxuICBQIGV4dGVuZHMgUm91dGVQYXJhbXM8Uj4gPSBSb3V0ZVBhcmFtczxSPixcbiAgLy8gZGVuby1saW50LWlnbm9yZSBuby1leHBsaWNpdC1hbnlcbiAgUyBleHRlbmRzIFN0YXRlID0gUmVjb3JkPHN0cmluZywgYW55Pixcbj4ge1xuICAvKiogQSBjYWxsYmFjayBob29rIHRoYXQgaXMgY2FsbGVkIGFmdGVyIHRoZSByZXNwb25zZSBpcyByZWNlaXZlZCB3aGljaCBhbGxvd3NcbiAgICogdGhlIHJlc3BvbnNlIGNvbnRlbnQgdHlwZSB0byBiZSBhZGp1c3RlZC4gVGhpcyBpcyBmb3Igc2l0dWF0aW9ucyB3aGVyZSB0aGVcbiAgICogY29udGVudCB0eXBlIHByb3ZpZGVkIGJ5IHRoZSBwcm94eSBzZXJ2ZXIgbWlnaHQgbm90IGJlIHN1aXRhYmxlIGZvclxuICAgKiByZXNwb25kaW5nIHdpdGguICovXG4gIGNvbnRlbnRUeXBlPyhcbiAgICB1cmw6IHN0cmluZyxcbiAgICBjb250ZW50VHlwZT86IHN0cmluZyxcbiAgKTogUHJvbWlzZTxzdHJpbmcgfCB1bmRlZmluZWQ+IHwgc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAvKiogVGhlIGZldGNoIGZ1bmN0aW9uIHRvIHVzZSB0byBwcm94eSB0aGUgcmVxdWVzdC4gVGhpcyBkZWZhdWx0cyB0byB0aGVcbiAgICogZ2xvYmFsIGBmZXRjaGAgZnVuY3Rpb24uIFRoaXMgaXMgZGVzaWduZWQgZm9yIHRlc3QgbW9ja2luZyBwdXJwb3Nlcy4gKi9cbiAgZmV0Y2g/OiBGZXRjaDtcbiAgLyoqIEFkZGl0aW9uYWwgaGVhZGVycyB0aGF0IHNob3VsZCBiZSBzZXQgaW4gdGhlIHJlc3BvbnNlLiBUaGUgdmFsdWUgY2FuXG4gICAqIGJlIGEgaGVhZGVycyBpbml0IHZhbHVlIG9yIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIG9yIHJlc29sdmVzIHdpdGggYVxuICAgKiBoZWFkZXJzIGluaXQgdmFsdWUuICovXG4gIGhlYWRlcnM/OlxuICAgIHwgSGVhZGVyc0luaXRcbiAgICB8IFByb3h5SGVhZGVyc0Z1bmN0aW9uPFM+XG4gICAgfCBQcm94eVJvdXRlckhlYWRlcnNGdW5jdGlvbjxSLCBQLCBTPjtcbiAgLyoqIEVpdGhlciBhIHJlY29yZCBvciBhIHByb3h5IG1hcCBmdW5jdGlvbiB0aGF0IHdpbGwgYWxsb3cgcHJveGllZCByZXF1ZXN0c1xuICAgKiBiZWluZyBoYW5kbGVkIGJ5IHRoZSBtaWRkbGV3YXJlIHRvIGJlIHJlbWFwcGVkIHRvIGEgZGlmZmVyZW50IHJlbW90ZVxuICAgKiBwYXRoLiAqL1xuICBtYXA/OiBSZWNvcmQ8c3RyaW5nLCBSPiB8IFByb3h5TWFwRnVuY3Rpb248UiwgUD47XG4gIC8qKiBBIHN0cmluZywgcmVndWxhciBleHByZXNzaW9uIG9yIHByb3h5IG1hdGNoIGZ1bmN0aW9uIHdoYXQgZGV0ZXJtaW5lcyBpZlxuICAgKiB0aGUgcHJveHkgbWlkZGxld2FyZSBzaG91bGQgcHJveHkgdGhlIHJlcXVlc3QuXG4gICAqXG4gICAqIElmIHRoZSB2YWx1ZSBpcyBhIHN0cmluZyB0aGUgbWF0Y2ggd2lsbCBiZSB0cnVlIGlmIHRoZSByZXF1ZXN0cyBwYXRobmFtZVxuICAgKiBzdGFydHMgd2l0aCB0aGUgc3RyaW5nLiBJbiB0aGUgY2FzZSBvZiBhIHJlZ3VsYXIgZXhwcmVzc2lvbiwgaWYgdGhlXG4gICAqIHBhdGhuYW1lXG4gICAqL1xuICBtYXRjaD86XG4gICAgfCBzdHJpbmdcbiAgICB8IFJlZ0V4cFxuICAgIHwgUHJveHlNYXRjaEZ1bmN0aW9uPFIsIFAsIFM+O1xuICAvKiogQSBmbGFnIHRoYXQgaW5kaWNhdGVzIGlmIHRyYWRpdGlvbmFsIHByb3h5IGhlYWRlcnMgc2hvdWxkIGJlIHNldCBpbiB0aGVcbiAgICogcmVzcG9uc2UuIFRoaXMgZGVmYXVsdHMgdG8gYHRydWVgLlxuICAgKi9cbiAgcHJveHlIZWFkZXJzPzogYm9vbGVhbjtcbiAgLyoqIEEgY2FsbGJhY2sgaG9vayB3aGljaCB3aWxsIGJlIGNhbGxlZCBiZWZvcmUgZWFjaCBwcm94aWVkIGZldGNoIHJlcXVlc3RcbiAgICogdG8gYWxsb3cgdGhlIG5hdGl2ZSBgUmVxdWVzdGAgdG8gYmUgbW9kaWZpZWQgb3IgcmVwbGFjZWQuICovXG4gIHJlcXVlc3Q/KHJlcTogUmVxdWVzdCk6IFJlcXVlc3QgfCBQcm9taXNlPFJlcXVlc3Q+O1xuICAvKiogQSBjYWxsYmFjayBob29rIHdoaWNoIHdpbGwgYmUgY2FsbGVkIGFmdGVyIGVhY2ggcHJveGllZCBmZXRjaCByZXNwb25zZVxuICAgKiBpcyByZWNlaXZlZCB0byBhbGxvdyB0aGUgbmF0aXZlIGBSZXNwb25zZWAgdG8gYmUgbW9kaWZpZWQgb3IgcmVwbGFjZWQuICovXG4gIHJlc3BvbnNlPyhyZXM6IFJlc3BvbnNlKTogUmVzcG9uc2UgfCBQcm9taXNlPFJlc3BvbnNlPjtcbn1cblxuY29uc3QgRk9SV0FSREVEX1JFID1cbiAgL14oLFsgXFxcXHRdKikqKFshIyQlJicqKy5eX2B8fjAtOUEtWmEtei1dKz0oWyEjJCUmJyorLl5fYHx+MC05QS1aYS16LV0rfFxcXCIoW1xcXFx0IFxcXFx4MjFcXFxceDIzLVxcXFx4NUJcXFxceDVELVxcXFx4N0VcXFxceDgwLVxcXFx4RkZdfFxcXFxcXFxcW1xcXFx0IFxcXFx4MjEtXFxcXHg3RVxcXFx4ODAtXFxcXHhGRl0pKlxcXCIpKT8oOyhbISMkJSYnKisuXl9gfH4wLTlBLVphLXotXSs9KFshIyQlJicqKy5eX2B8fjAtOUEtWmEtei1dK3xcXFwiKFtcXFxcdCBcXFxceDIxXFxcXHgyMy1cXFxceDVCXFxcXHg1RC1cXFxceDdFXFxcXHg4MC1cXFxceEZGXXxcXFxcXFxcXFtcXFxcdCBcXFxceDIxLVxcXFx4N0VcXFxceDgwLVxcXFx4RkZdKSpcXFwiKSk/KSooWyBcXFxcdF0qLChbIFxcXFx0XSooWyEjJCUmJyorLl5fYHx+MC05QS1aYS16LV0rPShbISMkJSYnKisuXl9gfH4wLTlBLVphLXotXSt8XFxcIihbXFxcXHQgXFxcXHgyMVxcXFx4MjMtXFxcXHg1QlxcXFx4NUQtXFxcXHg3RVxcXFx4ODAtXFxcXHhGRl18XFxcXFxcXFxbXFxcXHQgXFxcXHgyMS1cXFxceDdFXFxcXHg4MC1cXFxceEZGXSkqXFxcIikpPyg7KFshIyQlJicqKy5eX2B8fjAtOUEtWmEtei1dKz0oWyEjJCUmJyorLl5fYHx+MC05QS1aYS16LV0rfFxcXCIoW1xcXFx0IFxcXFx4MjFcXFxceDIzLVxcXFx4NUJcXFxceDVELVxcXFx4N0VcXFxceDgwLVxcXFx4RkZdfFxcXFxcXFxcW1xcXFx0IFxcXFx4MjEtXFxcXHg3RVxcXFx4ODAtXFxcXHhGRl0pKlxcXCIpKT8pKik/KSokLztcblxuZnVuY3Rpb24gY3JlYXRlTWF0Y2hlcjxcbiAgUiBleHRlbmRzIHN0cmluZyxcbiAgUCBleHRlbmRzIFJvdXRlUGFyYW1zPFI+LFxuICBTIGV4dGVuZHMgU3RhdGUsXG4+KFxuICB7IG1hdGNoIH06IFByb3h5T3B0aW9uczxSLCBQLCBTPixcbikge1xuICByZXR1cm4gZnVuY3Rpb24gbWF0Y2hlcyhjdHg6IFJvdXRlckNvbnRleHQ8UiwgUCwgUz4pOiBib29sZWFuIHtcbiAgICBpZiAoIW1hdGNoKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBtYXRjaCA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgcmV0dXJuIGN0eC5yZXF1ZXN0LnVybC5wYXRobmFtZS5zdGFydHNXaXRoKG1hdGNoKTtcbiAgICB9XG4gICAgaWYgKG1hdGNoIGluc3RhbmNlb2YgUmVnRXhwKSB7XG4gICAgICByZXR1cm4gbWF0Y2gudGVzdChjdHgucmVxdWVzdC51cmwucGF0aG5hbWUpO1xuICAgIH1cbiAgICByZXR1cm4gbWF0Y2goY3R4KTtcbiAgfTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY3JlYXRlUmVxdWVzdDxcbiAgUiBleHRlbmRzIHN0cmluZyxcbiAgUCBleHRlbmRzIFJvdXRlUGFyYW1zPFI+LFxuICBTIGV4dGVuZHMgU3RhdGUsXG4+KFxuICB0YXJnZXQ6IHN0cmluZyB8IFVSTCxcbiAgY3R4OiBDb250ZXh0PFM+IHwgUm91dGVyQ29udGV4dDxSLCBQLCBTPixcbiAgeyBoZWFkZXJzOiBvcHRIZWFkZXJzLCBtYXAsIHByb3h5SGVhZGVycyA9IHRydWUsIHJlcXVlc3Q6IHJlcUZuIH06XG4gICAgUHJveHlPcHRpb25zPFIsIFAsIFM+LFxuKTogUHJvbWlzZTxSZXF1ZXN0PiB7XG4gIGxldCBwYXRoID0gY3R4LnJlcXVlc3QudXJsLnBhdGhuYW1lIGFzIFI7XG4gIGxldCBwYXJhbXM6IFAgfCB1bmRlZmluZWQ7XG4gIGlmIChpc1JvdXRlckNvbnRleHQ8UiwgUCwgUz4oY3R4KSkge1xuICAgIHBhcmFtcyA9IGN0eC5wYXJhbXM7XG4gIH1cbiAgaWYgKG1hcCAmJiB0eXBlb2YgbWFwID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICBwYXRoID0gbWFwKHBhdGgsIHBhcmFtcyk7XG4gIH0gZWxzZSBpZiAobWFwKSB7XG4gICAgcGF0aCA9IG1hcFtwYXRoXSA/PyBwYXRoO1xuICB9XG4gIGNvbnN0IHVybCA9IG5ldyBVUkwoU3RyaW5nKHRhcmdldCkpO1xuICBpZiAodXJsLnBhdGhuYW1lLmVuZHNXaXRoKFwiL1wiKSAmJiBwYXRoLnN0YXJ0c1dpdGgoXCIvXCIpKSB7XG4gICAgdXJsLnBhdGhuYW1lID0gYCR7dXJsLnBhdGhuYW1lfSR7cGF0aC5zbGljZSgxKX1gO1xuICB9IGVsc2UgaWYgKCF1cmwucGF0aG5hbWUuZW5kc1dpdGgoXCIvXCIpICYmICFwYXRoLnN0YXJ0c1dpdGgoXCIvXCIpKSB7XG4gICAgdXJsLnBhdGhuYW1lID0gYCR7dXJsLnBhdGhuYW1lfS8ke3BhdGh9YDtcbiAgfSBlbHNlIHtcbiAgICB1cmwucGF0aG5hbWUgPSBgJHt1cmwucGF0aG5hbWV9JHtwYXRofWA7XG4gIH1cbiAgdXJsLnNlYXJjaCA9IGN0eC5yZXF1ZXN0LnVybC5zZWFyY2g7XG5cbiAgY29uc3QgYm9keSA9IGdldEJvZHlJbml0KGN0eCk7XG4gIGNvbnN0IGhlYWRlcnMgPSBuZXcgSGVhZGVycyhjdHgucmVxdWVzdC5oZWFkZXJzKTtcbiAgaWYgKG9wdEhlYWRlcnMpIHtcbiAgICBpZiAodHlwZW9mIG9wdEhlYWRlcnMgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgb3B0SGVhZGVycyA9IGF3YWl0IG9wdEhlYWRlcnMoY3R4IGFzIFJvdXRlckNvbnRleHQ8UiwgUCwgUz4pO1xuICAgIH1cbiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBpdGVyYWJsZUhlYWRlcnMob3B0SGVhZGVycykpIHtcbiAgICAgIGhlYWRlcnMuc2V0KGtleSwgdmFsdWUpO1xuICAgIH1cbiAgfVxuICBpZiAocHJveHlIZWFkZXJzKSB7XG4gICAgY29uc3QgbWF5YmVGb3J3YXJkZWQgPSBoZWFkZXJzLmdldChcImZvcndhcmRlZFwiKTtcbiAgICBjb25zdCBpcCA9IGN0eC5yZXF1ZXN0LmlwLnN0YXJ0c1dpdGgoXCJbXCIpXG4gICAgICA/IGBcIiR7Y3R4LnJlcXVlc3QuaXB9XCJgXG4gICAgICA6IGN0eC5yZXF1ZXN0LmlwO1xuICAgIGNvbnN0IGhvc3QgPSBoZWFkZXJzLmdldChcImhvc3RcIik7XG4gICAgaWYgKG1heWJlRm9yd2FyZGVkICYmIEZPUldBUkRFRF9SRS50ZXN0KG1heWJlRm9yd2FyZGVkKSkge1xuICAgICAgbGV0IHZhbHVlID0gYGZvcj0ke2lwfWA7XG4gICAgICBpZiAoaG9zdCkge1xuICAgICAgICB2YWx1ZSArPSBgO2hvc3Q9JHtob3N0fWA7XG4gICAgICB9XG4gICAgICBoZWFkZXJzLmFwcGVuZChcImZvcndhcmRlZFwiLCB2YWx1ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGhlYWRlcnMuYXBwZW5kKFwieC1mb3J3YXJkZWQtZm9yXCIsIGlwKTtcbiAgICAgIGlmIChob3N0KSB7XG4gICAgICAgIGhlYWRlcnMuYXBwZW5kKFwieC1mb3J3YXJkZWQtaG9zdFwiLCBob3N0KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBjb25zdCBpbml0OiBSZXF1ZXN0SW5pdCA9IHtcbiAgICBib2R5LFxuICAgIGhlYWRlcnMsXG4gICAgbWV0aG9kOiBjdHgucmVxdWVzdC5tZXRob2QsXG4gICAgcmVkaXJlY3Q6IFwiZm9sbG93XCIsXG4gIH07XG4gIGxldCByZXF1ZXN0ID0gbmV3IFJlcXVlc3QodXJsLnRvU3RyaW5nKCksIGluaXQpO1xuICBpZiAocmVxRm4pIHtcbiAgICByZXF1ZXN0ID0gYXdhaXQgcmVxRm4ocmVxdWVzdCk7XG4gIH1cbiAgcmV0dXJuIHJlcXVlc3Q7XG59XG5cbmZ1bmN0aW9uIGdldEJvZHlJbml0PFxuICBSIGV4dGVuZHMgc3RyaW5nLFxuICBQIGV4dGVuZHMgUm91dGVQYXJhbXM8Uj4sXG4gIFMgZXh0ZW5kcyBTdGF0ZSxcbj4oXG4gIGN0eDogQ29udGV4dDxTPiB8IFJvdXRlckNvbnRleHQ8UiwgUCwgUz4sXG4pOiBCb2R5SW5pdCB8IG51bGwge1xuICBpZiAoIWN0eC5yZXF1ZXN0Lmhhc0JvZHkpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuICByZXR1cm4gY3R4LnJlcXVlc3QuYm9keSh7IHR5cGU6IFwic3RyZWFtXCIgfSkudmFsdWU7XG59XG5cbmZ1bmN0aW9uIGl0ZXJhYmxlSGVhZGVycyhcbiAgaGVhZGVyczogSGVhZGVyc0luaXQsXG4pOiBJdGVyYWJsZUl0ZXJhdG9yPFtzdHJpbmcsIHN0cmluZ10+IHtcbiAgaWYgKGhlYWRlcnMgaW5zdGFuY2VvZiBIZWFkZXJzKSB7XG4gICAgcmV0dXJuIGhlYWRlcnMuZW50cmllcygpO1xuICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoaGVhZGVycykpIHtcbiAgICByZXR1cm4gaGVhZGVycy52YWx1ZXMoKSBhcyBJdGVyYWJsZUl0ZXJhdG9yPFtzdHJpbmcsIHN0cmluZ10+O1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBPYmplY3QuZW50cmllcyhoZWFkZXJzKS52YWx1ZXMoKSBhcyBJdGVyYWJsZUl0ZXJhdG9yPFxuICAgICAgW3N0cmluZywgc3RyaW5nXVxuICAgID47XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gcHJvY2Vzc1Jlc3BvbnNlPFxuICBSIGV4dGVuZHMgc3RyaW5nLFxuICBQIGV4dGVuZHMgUm91dGVQYXJhbXM8Uj4sXG4gIFMgZXh0ZW5kcyBTdGF0ZSxcbj4oXG4gIHJlc3BvbnNlOiBSZXNwb25zZSxcbiAgY3R4OiBDb250ZXh0PFM+IHwgUm91dGVyQ29udGV4dDxSLCBQLCBTPixcbiAgeyBjb250ZW50VHlwZTogY29udGVudFR5cGVGbiwgcmVzcG9uc2U6IHJlc0ZuIH06IFByb3h5T3B0aW9uczxSLCBQLCBTPixcbikge1xuICBpZiAocmVzRm4pIHtcbiAgICByZXNwb25zZSA9IGF3YWl0IHJlc0ZuKHJlc3BvbnNlKTtcbiAgfVxuICBpZiAocmVzcG9uc2UuYm9keSkge1xuICAgIGN0eC5yZXNwb25zZS5ib2R5ID0gcmVzcG9uc2UuYm9keTtcbiAgfSBlbHNlIHtcbiAgICBjdHgucmVzcG9uc2UuYm9keSA9IG51bGw7XG4gIH1cbiAgY3R4LnJlc3BvbnNlLnN0YXR1cyA9IHJlc3BvbnNlLnN0YXR1cztcbiAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgcmVzcG9uc2UuaGVhZGVycykge1xuICAgIGN0eC5yZXNwb25zZS5oZWFkZXJzLmFwcGVuZChrZXksIHZhbHVlKTtcbiAgfVxuICBpZiAoY29udGVudFR5cGVGbikge1xuICAgIGNvbnN0IHZhbHVlID0gYXdhaXQgY29udGVudFR5cGVGbihcbiAgICAgIHJlc3BvbnNlLnVybCxcbiAgICAgIGN0eC5yZXNwb25zZS5oZWFkZXJzLmdldChcImNvbnRlbnQtdHlwZVwiKSA/PyB1bmRlZmluZWQsXG4gICAgKTtcbiAgICBpZiAodmFsdWUgIT0gbnVsbCkge1xuICAgICAgY3R4LnJlc3BvbnNlLmhlYWRlcnMuc2V0KFwiY29udGVudC10eXBlXCIsIHZhbHVlKTtcbiAgICB9XG4gIH1cbn1cblxuLyoqXG4gKiBNaWRkbGV3YXJlIHRoYXQgcHJvdmlkZXMgYSBiYWNrLXRvLWJhY2sgcHJveHkgZm9yIHJlcXVlc3RzLlxuICpcbiAqIEBwYXJhbSB0YXJnZXRcbiAqIEBwYXJhbSBvcHRpb25zXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBwcm94eTxTIGV4dGVuZHMgU3RhdGU+KFxuICB0YXJnZXQ6IHN0cmluZyB8IFVSTCxcbiAgb3B0aW9ucz86IFByb3h5T3B0aW9uczxzdHJpbmcsIFJvdXRlUGFyYW1zPHN0cmluZz4sIFM+LFxuKTogTWlkZGxld2FyZTxTPjtcbmV4cG9ydCBmdW5jdGlvbiBwcm94eTxcbiAgUiBleHRlbmRzIHN0cmluZyxcbiAgUCBleHRlbmRzIFJvdXRlUGFyYW1zPFI+LFxuICBTIGV4dGVuZHMgU3RhdGUsXG4+KFxuICB0YXJnZXQ6IHN0cmluZyB8IFVSTCxcbiAgb3B0aW9uczogUHJveHlPcHRpb25zPFIsIFAsIFM+ID0ge30sXG4pOiBSb3V0ZXJNaWRkbGV3YXJlPFIsIFAsIFM+IHtcbiAgY29uc3QgbWF0Y2hlcyA9IGNyZWF0ZU1hdGNoZXIob3B0aW9ucyk7XG4gIHJldHVybiBhc3luYyBmdW5jdGlvbiBwcm94eShjdHgsIG5leHQpIHtcbiAgICBpZiAoIW1hdGNoZXMoY3R4KSkge1xuICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICB9XG4gICAgY29uc3QgcmVxdWVzdCA9IGF3YWl0IGNyZWF0ZVJlcXVlc3QodGFyZ2V0LCBjdHgsIG9wdGlvbnMpO1xuICAgIGNvbnN0IHsgZmV0Y2ggPSBnbG9iYWxUaGlzLmZldGNoIH0gPSBvcHRpb25zO1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2gocmVxdWVzdCk7XG4gICAgYXdhaXQgcHJvY2Vzc1Jlc3BvbnNlKHJlc3BvbnNlLCBjdHgsIG9wdGlvbnMpO1xuICAgIHJldHVybiBuZXh0KCk7XG4gIH07XG59XG4iXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEseUVBQXlFO0FBVXpFLFNBQVMsZUFBZSxRQUFRLFlBQVksQ0FBQztBQTZFN0MsTUFBTSxZQUFZLG1uQkFDZ21CLEFBQUM7QUFFbm5CLFNBQVMsYUFBYSxDQUtwQixFQUFFLEtBQUssQ0FBQSxFQUF5QixFQUNoQztJQUNBLE9BQU8sU0FBUyxPQUFPLENBQUMsR0FBMkIsRUFBVztRQUM1RCxJQUFJLENBQUMsS0FBSyxFQUFFO1lBQ1YsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDO1FBQ0QsSUFBSSxPQUFPLEtBQUssS0FBSyxRQUFRLEVBQUU7WUFDN0IsT0FBTyxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3BELENBQUM7UUFDRCxJQUFJLEtBQUssWUFBWSxNQUFNLEVBQUU7WUFDM0IsT0FBTyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzlDLENBQUM7UUFDRCxPQUFPLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNwQixDQUFDLENBQUM7QUFDSixDQUFDO0FBRUQsZUFBZSxhQUFhLENBSzFCLE1BQW9CLEVBQ3BCLEdBQXdDLEVBQ3hDLEVBQUUsT0FBTyxFQUFFLFVBQVUsQ0FBQSxFQUFFLEdBQUcsQ0FBQSxFQUFFLFlBQVksRUFBRyxJQUFJLENBQUEsRUFBRSxPQUFPLEVBQUUsS0FBSyxDQUFBLEVBQ3hDLEVBQ0w7SUFDbEIsSUFBSSxJQUFJLEdBQUcsR0FBRyxDQUFDLE9BQU8s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